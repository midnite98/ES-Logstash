input {
  http {
    host => "{{LOGSTASH_HOST}}"
    port => "{{PIPELINE_PORT}}"
  }
 }

filter {

    if [finalize] {
    }
    else if ![finalize] {
    if "@" in [headers][request_path] or "%40" in [headers][request_path] and "ipCheck" in [headers][request_path] or "urlCheck" in [headers][request_path] or "domainCheck" in [headers][request_path] or "hashCheck" in [headers][request_path] or "mailCheck" in [headers][request_path] {
    mutate {
         update => { "message" => "]%{message}1998" }
         gsub => [ "message", "\r", "" ]
         gsub => [ "message", "\n", "" ]
         add_tag => [ "Initialize" ]
     }
     grok {
         match => { "[headers][request_path]" => "checker/(?<route>.*?)[/](?<email>.*)" }
#         match => { "[headers][request_path]" => "[/](?<route>.*?)[/](?<email>.*)" }
     }
     if "%40" in [email] {
         mutate {
            gsub => [ "email", "%40", "@" ]
      }
     }
    }
    else { drop{} }
    ruby {
         code => "
              mat = event.get('message').scan(/((?<=])[^\,]+)/)
              mat2 = event.get('message').scan(/(\[.*?])/)
              event.set('split', mat.flatten)
              event.set('split2', mat2.flatten)
         "
     }
    ruby {
        code => '
            f1 = event.get("split")
            f2 = event.get("split2")
            a = []
            f1.each_index { |i|
                a << "#{f1[i]}:#{f2[i]}"
            }
            event.set("result", a)
        '
    }
    split {
        field => "result"
    }
    if "[]" in [result] {
    mutate {
         gsub => [ "result", ":\[]", ":[False_Positive]" ]
     }
    }
    grok {
         match => [ "result", "(?<ioc>.*?)[:][\[](?<globaltag>.*)[\]]" ]
    }
   urldecode {
         field => "ioc"
   }
   sleep {
        time => "10"
        every => 10
   }
   ruby {
         init => "
             require 'net/http'
             require 'uri'
             require 'json'
             require 'openssl'
          "

          code => "
             uri = URI.parse('https://{{MISP_HOST}}/attributes/restSearch')
             request = Net::HTTP::Post.new(uri)
             request.content_type = 'application/json'
             request['Accept'] = 'application/json'
             request['Authorization'] = '{{MISP_API_KEY}}'
             request.body = JSON.dump({
                'value' => event.get('[ioc]'),
                'eventid' => [ 1, 2, 11 ],
                'limit' => 1
             })

             req_options = {
               use_ssl: uri.scheme == 'https',
               verify_mode: OpenSSL::SSL::VERIFY_NONE,
             }

             response = Net::HTTP.start(uri.hostname, uri.port, req_options) do |http|
               http.request(request)
             end

             if response.code == '200'
               result = JSON.parse(response.body)
               event.set('[status]', result)
             end
             "
   }
     mutate {
         remove_field => [ "headers", "host", "message", "result", "split", "split2" ]
         capitalize => [ "globaltag" ]
    }
    if ![status][response][Attribute][0] {
     mutate{
         remove_tag => [ "%{[tags][0]}"  ]
         add_tag => [ "NotFound" ]
    }
  }
    else if [status][response][Attribute][0] {
      mutate{
         remove_tag => [ "%{[tags][0]}"  ]
         add_tag => [ "IOC found in Misp record" ]
    }
  }
    if "NotFound" in [tags] {
      ruby {
         init => "
             require 'net/http'
             require 'uri'
             require 'json'
             require 'openssl'
          "

      code => "
         uri = URI.parse('https://{{ELASTIC_COORDINATOR}}:9200/misp*/_search')
         request = Net::HTTP::Post.new(uri)
         request.basic_auth('elastic', '{{ELASTIC_PASS}}')
         request.content_type = 'application/json'
         request.body = JSON.dump({
           'query' => {
             'match' => {
               'ioc' => event.get('[ioc]')
             }
           },
           'size' => 1,
           'sort' => [
             {
               '@timestamp' => {
                 'order' => 'desc'
               }
             }
           ]
         })

         req_options = {
           use_ssl: uri.scheme == 'https',
           verify_mode: OpenSSL::SSL::VERIFY_NONE,
         }

         response = Net::HTTP.start(uri.hostname, uri.port, req_options) do |http|
           http.request(request)
         end

         if response.code == '200'
               result = JSON.parse(response.body)
               event.set('[status]', result)
         end
         "
  }

         if [status][hits][hits][0] {
             mutate {
                remove_tag => [ "%{[tags][0]}"  ]
                add_tag => [ "IOC found in Elastic record" ]
  }
 }
         else if ![status][hits][hits][0] {
             mutate {
                remove_field => [ "status", "@version" ]
  }
 }
}
         if "_rubyexception" in [tags] or "_split_type_failure" in [tags] {drop{}}
         if "_grokparsefailure" in [tags] {
             prune { whitelist_names => [ "email" ]
                     add_field => { "end_of_line" => "terminate"}}
         }
         if "NotFound" in [tags] and "ipCheck" in [route] {
             http {
                automatic_retries => 3
                connect_timeout => 5
                url => "https://api.abuseipdb.com/api/v2/check"
                verb => GET
                query => { 'ipAddress' => '%{ioc}' }
                body => { "maxAgeInDays" => "365" "verbose" => "0" } body_format => "json"
                headers => { "Key" => "{{ABUSE_API_KEY}}"
                             "Content-Type" => "application/json" }
                target_body => "analysis"
             }

             if [analysis][data][lastReportedAt] {
             mutate {
                remove_tag => [ "%{[tags][0]}"  ]
                add_tag => [ "IOC found in External record" ]
                remove_field => [ "headers" ]
                add_field => { "scoring" => "%{[analysis][data][abuseConfidenceScore]}% Abuse-score" }
  }
 }
              else if ![analysis][data][lastReportedAt] {
              mutate {
#                remove_field => [ "headers", "analysis" ]
                remove_field => [ "headers" ]
##########################
#                add_field => { "[analysis][data][reports][0][comment]" => "-" }
                add_field => { "[scoring]" => "0% Abuse-score" }
##########################
                add_field => { "comment" => "Unable to retrieve any matched reputation against our existed record" }
                add_field => { "void" => "N/A" }
                add_field => { "statement" => "IOC's first discovery" }
   }
  }
 }
         if "NotFound" in [tags] and "urlCheck" in [route] {
             mutate {
                gsub => [ "ioc", "#", "%23" ]
                gsub => [ "ioc", "\$", "%24" ]
                gsub => [ "ioc", "&", "%26" ]
                gsub => [ "ioc", "\+", "%2B" ]
                gsub => [ "ioc", "/", "%2F" ]
                gsub => [ "ioc", ":", "%3A" ]
                gsub => [ "ioc", ";", "%3B" ]
                gsub => [ "ioc", "=", "%3D" ]
                gsub => [ "ioc", "\?", "%3F" ]
                gsub => [ "ioc", "@", "%40" ]
             }
             http {
                automatic_retries => 3
                connect_timeout => 5
                url => "https://api.metadefender.com/v4/url/%{ioc}"
                verb => GET
                headers => { "apikey" => "{{OPSWAT_API_KEY}}"
                             "Content-Type" => "application/json" }
                target_body => "analysis"
             }

             if [analysis][lookup_results][detected_by] >= 1 {
             mutate {
                remove_tag => [ "%{[tags][0]}"  ]
                add_tag => [ "IOC found in External record" ]
                remove_field => [ "headers", "status" ]
                copy => { "[analysis][address]" => "ioc" }
             }

             if [analysis][lookup_results][sources][0][category] == "" {
              mutate {
                remove_field => [ "[analysis][lookup_results][sources][0][category]"  ]
              }
             }
             if [analysis][lookup_results][sources][0][assessment] == "" {
              mutate {
                remove_field => [ "[analysis][lookup_results][sources][0][assessment]"  ]
              }
             }
########################
#             if ![analysis][lookup_results][sources][0][category] {
#                mutate {
#                    add_field => { "[analysis][lookup_results][sources][0][category]" => "N/A" }
#             }}
#             if ![analysis][lookup_results][sources][0][assessment] {
#                mutate {
#                    add_field => { "[analysis][lookup_results][sources][0][assessment]" => "N/A" }
#             }}
 }

              else if "NotFound" in [tags] {
              mutate {
                remove_field => [ "headers", "analysis", "status" ]
                add_field => { "void" => "N/A" }
                add_field => { "capture" => "Unable to retrieve any matched reputation against our existed record" }
                add_field => { "statement" => "IOC's first discovery" }
              }
              urldecode {
                field => "ioc"
              }
              if [analysis][lookup_results][sources][0][category] == "" {
              mutate {
                remove_field => [ "[analysis][lookup_results][sources][0][category]"  ]
              }
             }
              if [analysis][lookup_results][sources][0][assessment] == "" {
              mutate {
                 remove_field => [ "[analysis][lookup_results][sources][0][assessment]"  ]
               }
              }
             }
            }
########################
             if ![analysis][lookup_results][sources][0][category] {
               mutate {
                   add_field => { "[analysis][lookup_results][sources][0][category]" => "N/A" }
             }}
             if ![analysis][lookup_results][sources][0][assessment] {
               mutate {
                   add_field => { "[analysis][lookup_results][sources][0][assessment]" => "N/A" }
             }}
#  }
# }

         if "NotFound" in [tags] and "domainCheck" in [route] {
             http {
                automatic_retries => 3
                connect_timeout => 5
                url => "https://api.metadefender.com/v4/domain/%{ioc}"
                verb => GET
                headers => { "apikey" => "{{OPSWAT_API_KEY}}"
                             "Content-Type" => "application/json" }
                target_body => "analysis"
             }

             if [analysis][lookup_results][detected_by] >= 1 {
             mutate {
                remove_tag => [ "%{[tags][0]}"  ]
                add_tag => [ "IOC found in External record" ]
                remove_field => [ "headers", "status" ]
             }

             if [analysis][lookup_results][sources][0][assessment] == "" {
              mutate {
                remove_field => [ "[analysis][lookup_results][sources][0][assessment]"  ]
              }
             }
             if [analysis][lookup_results][sources][0][category] == "" {
              mutate {
                remove_field => [ "[analysis][lookup_results][sources][0][category]"  ]
              }
             }

             if ![analysis][lookup_results][sources][0][category] {
                mutate {
                    add_field => { "[analysis][lookup_results][sources][0][category]" => "N/A" }
             }}
             if ![analysis][lookup_results][sources][0][assessment] {
                mutate {
                    add_field => { "[analysis][lookup_results][sources][0][assessment]" => "N/A" }
             }}
 }
              else if "NotFound" in [tags] and "domainCheck" in [route] {
              mutate {
                remove_field => [ "headers", "analysis", "status", "[analysis][lookup_results][sources][0][assessment]", "[analysis][lookup_results][sources][0][category]" ]
                add_field => { "void" => "N/A" }
                add_field => { "capture" => "Unable to retrieve any matched reputation against our existed record" }
                add_field => { "statement" => "IOC's first discovery" }
              }
              if ![analysis][lookup_results][sources][0][category] {
                mutate {
                    add_field => { "[analysis][lookup_results][sources][0][category]" => "N/A" }
              }}
              if ![analysis][lookup_results][sources][0][assessment] {
                mutate {
                    add_field => { "[analysis][lookup_results][sources][0][assessment]" => "N/A" }
              }}
  }
 }
         if "NotFound" in [tags] and "hashCheck" in [route] {
             http {
                automatic_retries => 3
                connect_timeout => 5
                url => "https://api.metadefender.com/v4/hash/%{ioc}"
                verb => GET
                headers => { "apikey" => "{{OPSWAT_API_KEY}}"
                             "Content-Type" => "application/json" }
                target_body => "analysis"
             }

             if [analysis][scan_results] {
             if ![analysis][file_info][file_type_description] {
             mutate {
                add_field => { "[analysis][file_info][file_type_description]" => "N/A" }
              }
             }
             if ![analysis][file_info][md5] {
             mutate {
                add_field => { "[analysis][file_info][md5]" => "N/A" }
              }
             }
             else if [analysis][file_info][md5] { mutate { lowercase => "[analysis][file_info][md5]" }}

             if ![analysis][file_info][sha1] {
             mutate {
                add_field => { "[analysis][file_info][sha1]" => "N/A" }
              }
             }
             else if [analysis][file_info][sha1] { mutate { lowercase => "[analysis][file_info][sha1]" }}

             if ![analysis][file_info][sha256] {
             mutate {
                add_field => { "[analysis][file_info][sha256]" => "N/A" }
              }
             }
             else if [analysis][file_info][sha256] { mutate { lowercase => "[analysis][file_info][sha256]" }}

             mutate {
                remove_tag => [ "%{[tags][0]}"  ]
                add_tag => [ "IOC found in External record" ]
                remove_field => [ "headers", "status", "@version", "[analysis][votes]", "[analysis][last_sandbox_id]", "[analysis][file_id]", "[analysis][data_id]", "[analysis][process_info]", "[analysis][scan_results][rescan_available]", "[analysis][scan_results][scan_all_result_i]", "[analysis][scan_results][start_time]", "[analysis][scan_results][total_time]", "[analysis][scan_results][progress_percentage]", "[analysis][scan_results][scan_all_result_a]", "[analysis][file_info][file_size]", "[analysis][file_info][upload_timestamp]", "[analysis][share_file]", "[analysis][rest_version]", "[analysis][additional_info]", "[analysis][scan_result_history_length]", "[analysis][malware_type]", "[analysis][file_type_category]" ]
                lowercase => [ "[ioc]" ]
                add_field => { "avengine" => "Triggered on (%{[analysis][scan_results][total_detected_avs]} out of %{[analysis][scan_results][total_avs]}) detection engine / antivirus" }
  }
 }
              else if ![analysis][scan_results] {
              mutate {
                remove_field => [ "headers", "status" ]
                remove_tag => [ "%{[tags][1]}" ]
                add_field => { "[hash_type]" => "filename" }
                add_field => { "[void]" => "N/A" }
                add_field => { "[capture]" => "Unable to retrieve any matched reputation against our existed record" }
                add_field => { "[statement]" => "IOC's first discovery" }
   }
  }
 }
              if "_httprequestfailure" in [tags] {
              mutate {
                remove_tag => [ "%{[tags][0]}","%{[tags][1]}" ]
                add_tag => [ "Wrong Endpoint or Exceed Daily Limitation" ]
   }
  }
          if ![end_of_line] {
             if [ioc] == [analysis][file_info][md5] {
             mutate {
                add_field => { "hash_type" => "md5" }
              }
             }
             else if [ioc] == [analysis][file_info][sha1] {
             mutate {
                add_field => { "hash_type" => "sha1" }
              }
             }
             else if [ioc] == [analysis][file_info][sha256] {
             mutate {
                add_field => { "hash_type" => "sha256" }
              }
             }
            }
            fingerprint {
                   source => "ioc"
                   target => "z-identifier"
                   method => "SHA256"
                   key => "Threat_Intelligence"
                   base64encode => true
            }

#        if ![analysis][lookup_results][sources][0][category] {
#                mutate {
#                    add_field => { "[analysis][lookup_results][sources][0][category]" => "N/A" }
#              }}
#        if ![analysis][lookup_results][sources][0][assessment] {
#                mutate {
#                    add_field => { "[analysis][lookup_results][sources][0][assessment]" => "N/A" }
#              }}

        if "IOC found in External record" in [tags] and "domainCheck" in [route] or "urlCheck" in [route] {
         if [analysis][lookup_results][sources][0][status] == 0 {
             mutate {  add_field => { "verification" => "No-match" } }
             mutate {  add_field => { "comment" => "This ioc was verified as (Malicious) against our intel" }
   }
  }
         else if [analysis][lookup_results][sources][0][status] == 5 {
             mutate {  add_field => { "verification" => "Unknown" } }
             mutate {  add_field => { "comment" => "This ioc was verified as (Malicious) against our intel" }
   }
  }
         else if [analysis][lookup_results][sources][0][status] != 0 and [analysis][lookup_results][sources][0][status] != 5 {
             mutate {  add_field => { "verification" => "Risky" } }
             mutate {  add_field => { "comment" => "This ioc was verified as (Malicious) against our intel" }
    }
   }
  }
 }
}
output {
################### TEMPLATE #######################
     if "ipCheck" in [route] {
      exec {
          command => "echo 'IOC, Feeder, Domain, Country, Abuse Score, ISP, Analysis, Comment' > /tmp/reputation_report.csv"
      }
     }
     else if "urlCheck" in [route] {
      exec {
          command => "echo 'IOC, Feeder, Category, Assessment, Analysis, Comment' > /tmp/reputation_report.csv"
       }
      }
     else if "domainCheck" in [route] {
      exec {
          command => "echo 'IOC, Feeder, Category, Assessment, Analysis, Comment' > /tmp/reputation_report.csv"
       }
      }
     else if "hashCheck" in [route] {
      exec {
          command => "echo 'IOC, Feeder, Detection_engine, Threat_name, Malware_family, File_Type, Hash_Type, Analysis' > /tmp/reputation_report.csv"
       }
      }
################### SIGHTING #######################
     if "IOC found in Misp record" in [tags] {
      exec {
          command => 'curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
          quiet => true
      }
     }
################ MISP CONDITION ####################
     if "IOC found in Misp record" in [tags] and "ipCheck" in [route] {
      csv {
          fields => [ "[ioc]", "[status][response][Attribute][0][Tag][1][name]", "[status][response][Attribute][0][Tag][5][name]", "[status][response][Attribute][0][Tag][4][name]", "[status][response][Attribute][0][Tag][3][name]", "[status][response][Attribute][0][Tag][2][name]", "[tags][0]", "[status][response][Attribute][0][comment]" ]
          path => "/tmp/reputation_report.csv"
      }
     }
     else if "IOC found in Misp record" in [tags] and "urlCheck" in [route] {
      csv {
          fields => [ "[ioc]", "[status][response][Attribute][0][Tag][1][name]", "[status][response][Attribute][0][Tag][4][name]", "[status][response][Attribute][0][Tag][3][name]", "[tags][0]", "[status][response][Attribute][0][comment]" ]
          path => "/tmp/reputation_report.csv"
      }
     }
     else if "IOC found in Misp record" in [tags] and "domainCheck" in [route] {
      csv {
          fields => [ "[ioc]", "[status][response][Attribute][0][Tag][1][name]", "[status][response][Attribute][0][Tag][4][name]", "[status][response][Attribute][0][Tag][3][name]", "[tags][0]", "[status][response][Attribute][0][comment]" ]
          path => "/tmp/reputation_report.csv"
      }
     }
     else if "IOC found in Misp record" in [tags] and "hashCheck" in [route] {
      csv {
          fields => [ "[ioc]", "[status][response][Attribute][0][Tag][1][name]", "[status][response][Attribute][0][comment]", "[status][response][Attribute][0][Tag][3][name]", "[status][response][Attribute][0][Tag][4][name]", "[status][response][Attribute][0][Tag][5][name]", "[status][response][Attribute][0][type]", "[tags][0]" ]
          path => "/tmp/reputation_report.csv"
      }
     }

##################### IP CHECK #####################
     if "NotFound" in [tags] and "ipCheck" in [route] {
      exec {
#          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{[void]}\"},{\"name\":\"%{[void]}\"},{\"name\":\"%{[void]}\"},{\"name\":\"%{[void]}\"}],\"category\":\"Network activity\",\"type\":\"ip-src\",\"value\":\"%{ioc}\",\"comment\":\"%{[comment]}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{[analysis][data][isp]}\"},{\"name\":\"%{[analysis][data][abuseConfidenceScore]}% Abuse-score\"},{\"name\":\"%{[analysis][data][countryName]}\"},{\"name\":\"%{[analysis][data][domain]}\"}],\"category\":\"Network activity\",\"type\":\"ip-src\",\"value\":\"%{ioc}\",\"comment\":\"%{[comment]}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
#          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{[analysis][data][isp]}\"},{\"name\":\"0% Abuse-score\"},{\"name\":\"%{[analysis][data][countryName]}\"},{\"name\":\"%{[analysis][data][domain]}\"}],\"category\":\"Network activity\",\"type\":\"ip-src\",\"value\":\"%{ioc}\",\"comment\":\"%{[analysis][data][reports][0][comment]}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'

          quiet => true
      }
      csv {
#         fields => [ "[ioc]", "[globaltag]", "[void]", "[void]", "[void]", "[void]", "[statement]", "[comment]" ]
#         fields => [ "[ioc]", "[globaltag]", "[analysis][data][domain]", "[analysis][data][countryName]", "[scoring]", "[analysis][data][isp]", "[tags][0]", "[analysis][data][reports][0][comment]" ]
         fields => [ "[ioc]", "[globaltag]", "[analysis][data][domain]", "[analysis][data][countryName]", "[scoring]", "[analysis][data][isp]", "[statement]", "[comment]" ]
         path => "/tmp/reputation_report.csv"
      }
     }

     if "IOC found in External record" in [tags] and "ipCheck" in [route] {
      exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{[analysis][data][isp]}\"},{\"name\":\"%{[analysis][data][abuseConfidenceScore]}% Abuse-score\"},{\"name\":\"%{[analysis][data][countryName]}\"},{\"name\":\"%{[analysis][data][domain]}\"}],\"category\":\"Network activity\",\"type\":\"ip-src\",\"value\":\"%{ioc}\",\"comment\":\"%{[analysis][data][reports][0][comment]}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
          quiet => true
      }
      csv {
         fields => [ "[ioc]", "[globaltag]", "[analysis][data][domain]", "[analysis][data][countryName]", "[scoring]", "[analysis][data][isp]", "[tags][0]", "[analysis][data][reports][0][comment]" ]
         path => "/tmp/reputation_report.csv"
      }
     }
##################### URL CHECK #####################
     if "NotFound" in [tags] and "urlCheck" in [route] {
      if [analysis][lookup_results][sources][0][status] == 0 {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{void}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][category]}\"}],\"category\":\"External analysis\",\"type\":\"url\",\"value\":\"%{[ioc]}\",\"comment\":\"%{capture}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] == 5 {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{void}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][category]}\"}],\"category\":\"External analysis\",\"type\":\"url\",\"value\":\"%{[ioc]}\",\"comment\":\"%{capture}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] != 0 and [analysis][lookup_results][sources][0][status] != 5 {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{void}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][category]}\"}],\"category\":\"External analysis\",\"type\":\"url\",\"value\":\"%{[ioc]}\",\"comment\":\"%{capture}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
      }}
      csv {
          fields => [ "[ioc]", "[globaltag]", "[analysis][lookup_results][sources][0][category]", "[analysis][lookup_results][sources][0][assessment]", "[statement]", "[capture]" ]
          path =>  "/tmp/reputation_report.csv"
      }
     }

     if "urlCheck" in [route] and "IOC found in External record" in [tags] and [analysis][lookup_results][detected_by] >= 1 {
      if [analysis][lookup_results][sources][0][status] == 0 {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"No-match\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][category]}\"}],\"category\":\"External analysis\",\"type\":\"url\",\"value\":\"%{[analysis][address]}\",\"comment\":\"%{comment}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[analysis][address]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] == 5 {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"Unknown\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][category]}\"}],\"category\":\"External analysis\",\"type\":\"url\",\"value\":\"%{[analysis][address]}\",\"comment\":\"%{comment}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[analysis][address]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] != 0 and [analysis][lookup_results][sources][0][status] != 5 {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"Risky\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][category]}\"}],\"category\":\"External analysis\",\"type\":\"url\",\"value\":\"%{[analysis][address]}\",\"comment\":\"%{comment}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[analysis][address]}\"}"'
          quiet => true
      }}
      csv {
          fields => [ "[analysis][address]", "[globaltag]", "[analysis][lookup_results][sources][0][category]", "[analysis][lookup_results][sources][0][assessment]", "[tags][0]", "[comment]" ]
          path =>  "/tmp/reputation_report.csv"
      }
     }
##################### DOMAIN CHECK #####################
      if "domainCheck" in [route] and "IOC found in External record" in [tags] and [analysis][lookup_results][detected_by] >= 1 {
       if [analysis][lookup_results][sources][0][status] == 0 and ![analysis][lookup_results][sources][0][category] {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"No-match\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{[ioc]}\",\"comment\":\"%{comment}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] == 0 and [analysis][lookup_results][sources][0][category] {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"No-match\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][category]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{[ioc]}\",\"comment\":\"%{comment}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] == 5 and ![analysis][lookup_results][sources][0][category] {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"Unknown\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{[ioc]}\",\"comment\":\"%{comment}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] == 5 and [analysis][lookup_results][sources][0][category] {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"Unknown\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][category]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{[ioc]}\",\"comment\":\"%{comment}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] != 0 and [analysis][lookup_results][sources][0][status] != 5 and ![analysis][lookup_results][sources][0][category] {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"Risky\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{[ioc]}\",\"comment\":\"%{comment}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] != 0 and [analysis][lookup_results][sources][0][status] != 5 and [analysis][lookup_results][sources][0][category] {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"Risky\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][category]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{[ioc]}\",\"comment\":\"%{comment}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
      }}
      csv {
          fields => [ "[ioc]", "[globaltag]", "[analysis][lookup_results][sources][0][category]", "[analysis][lookup_results][sources][0][assessment]", "[tags][0]", "[comment]" ]
          path =>  "/tmp/reputation_report.csv"
      }
     }

     if "NotFound" in [tags] and "domainCheck" in [route] {
       if [analysis][lookup_results][sources][0][status] == 0 and ![analysis][lookup_results][sources][0][category] {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{void}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{[ioc]}\",\"comment\":\"%{capture}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] == 0 and [analysis][lookup_results][sources][0][category] {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{void}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][category]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{[ioc]}\",\"comment\":\"%{capture}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] == 5 and ![analysis][lookup_results][sources][0][category] {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{void}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{[ioc]}\",\"comment\":\"%{capture}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] == 5 and [analysis][lookup_results][sources][0][category] {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{void}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][category]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{[ioc]}\",\"comment\":\"%{capture}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] != 0 and [analysis][lookup_results][sources][0][status] != 5 and ![analysis][lookup_results][sources][0][category] {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{void}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{[ioc]}\",\"comment\":\"%{capture}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
       }}
       else if [analysis][lookup_results][sources][0][status] != 0 and [analysis][lookup_results][sources][0][status] != 5 and [analysis][lookup_results][sources][0][category] {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{void}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][assessment]}\"},{\"name\":\"%{[analysis][lookup_results][sources][0][category]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{[ioc]}\",\"comment\":\"%{capture}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
      }}
      csv {
          fields => [ "[ioc]", "[globaltag]", "[analysis][lookup_results][sources][0][category]", "[analysis][lookup_results][sources][0][assessment]", "[statement]", "[capture]" ]
          path =>  "/tmp/reputation_report.csv"
      }
     }
##################### HASH CHECK #####################
      if "IOC found in External record" in [tags] and "hashCheck" in [route] {
       if [analysis][file_info][sha256] != "N/A" {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{[analysis][scan_results][total_detected_avs]} / %{[analysis][scan_results][total_avs]} Av\"},{\"name\":\"%{[analysis][threat_name]}\"},{\"name\":\"%{[analysis][malware_family]}\"},{\"name\":\"%{[analysis][file_info][file_type_description]}\"}],\"category\":\"Payload delivery\",\"type\":\"sha256\",\"value\":\"%{[analysis][file_info][sha256]}\",\"comment\":\"Triggered on (%{[analysis][scan_results][total_detected_avs]} out of %{[analysis][scan_results][total_avs]}) detection engine / antivirus\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[analysis][file_info][sha256]}\"}"'
          quiet => true
       }
      }
      if [analysis][file_info][sha1] != "N/A" {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{[analysis][scan_results][total_detected_avs]} / %{[analysis][scan_results][total_avs]} Av\"},{\"name\":\"%{[analysis][threat_name]}\"},{\"name\":\"%{[analysis][malware_family]}\"},{\"name\":\"%{[analysis][file_info][file_type_description]}\"}],\"category\":\"Payload delivery\",\"type\":\"sha1\",\"value\":\"%{[analysis][file_info][sha1]}\",\"comment\":\"Triggered on (%{[analysis][scan_results][total_detected_avs]} out of %{[analysis][scan_results][total_avs]}) detection engine / antivirus\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[analysis][file_info][sha1]}\"}"'
          quiet => true
       }
      }
      if [analysis][file_info][md5] != "N/A" {
       exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{[analysis][scan_results][total_detected_avs]} / %{[analysis][scan_results][total_avs]} Av\"},{\"name\":\"%{[analysis][threat_name]}\"},{\"name\":\"%{[analysis][malware_family]}\"},{\"name\":\"%{[analysis][file_info][file_type_description]}\"}],\"category\":\"Payload delivery\",\"type\":\"md5\",\"value\":\"%{[analysis][file_info][md5]}\",\"comment\":\"Triggered on (%{[analysis][scan_results][total_detected_avs]} out of %{[analysis][scan_results][total_avs]}) detection engine / antivirus\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[analysis][file_info][md5]}\"}"'
          quiet => true
       }
      }
      csv {
          fields =>  [ "[ioc]", "[globaltag]", "[avengine]", "[analysis][threat_name]", "[analysis][malware_family]", "[analysis][file_info][file_type_description]", "[hash_type]", "[tags][0]" ]
          path =>  "/tmp/reputation_report.csv"
      }
     }

    if "NotFound" in [tags] and "hashCheck" in [route] {
     exec {
          command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"External Apis\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{[void]}\"},{\"name\":\"%{[void]}\"},{\"name\":\"%{[void]}\"},{\"name\":\"%{[void]}\"}],\"category\":\"Payload delivery\",\"type\":\"filename\",\"value\":\"%{[ioc]}\",\"comment\":\"%{[capture]}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{[ioc]}\"}"'
          quiet => true
       }
     csv {
          fields =>  [ "[ioc]", "[globaltag]", "[capture]", "[void]", "[void]", "[void]", "[hash_type]", "[statement]" ]
          path =>  "/tmp/reputation_report.csv"
      }
     }
##### IOC EXISTED IN ELASTIC FROM EXTERNAL FEEDER #####
    if "IOC found in Elastic record" in [tags] and "IOC found in External record" in [status][hits][hits][0][_source][tags][0] and "ipCheck" in [route] {
    exec {
        command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Returnee\"},{\"name\":\"%{[status][hits][hits][0][_source][globaltag]}\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][data][isp]}\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][data][abuseConfidenceScore]}% Abuse-score\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][data][countryName]}\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][data][domain]}\"}],\"category\":\"Network activity\",\"type\":\"ip-src\",\"value\":\"%{ioc}\",\"comment\":\"%{[status][hits][hits][0][_source][analysis][data][reports][0][comment]}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
        quiet => true
     }
    csv {
         fields => [ "[ioc]", "[status][hits][hits][0][_source][globaltag]", "[status][hits][hits][0][_source][analysis][data][domain]", "[status][hits][hits][0][_source][analysis][data][countryName]", "[status][hits][hits][0][_source][scoring]", "[status][hits][hits][0][_source][analysis][data][isp]", "[tags][0]", "[status][hits][hits][0][_source][analysis][data][reports][0][comment]" ]
         path => "/tmp/reputation_report.csv"
     }
    }
##### IOC EXISTED IN ELASTIC FROM MISP FEEDER #####
    else if "IOC found in Elastic record" in [tags] and "IOC found in Misp record" in [status][hits][hits][0][_source][tags][0] and "ipCheck" in [route] {
    exec {
        command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Misp\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][5][name]}\"}],\"category\":\"Network activity\",\"type\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][type]}\",\"value\":\"%{ioc}\",\"comment\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][comment]}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
        quiet => true
     }
    csv {
        fields => [ "[ioc]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][5][name]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]", "[tags][0]", "[status][hits][hits][0][_source][status][response][Attribute][0][comment]" ]
        path => "/tmp/reputation_report.csv"
     }
    }
##### IOC EXISTED IN ELASTIC FROM EXTERNAL FEEDER #####
    if "IOC found in Elastic record" in [tags] and "IOC found in External record" in [status][hits][hits][0][_source][tags][0] and "hashCheck" in [route] {
    exec {
        command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Returnee\"},{\"name\":\"%{[status][hits][hits][0][_source][globaltag]}\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][scan_results][total_detected_avs]} / %{[status][hits][hits][0][_source][analysis][scan_results][total_avs]} Av\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][threat_name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][malware_family]}\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][file_info][file_type_description]}\"}],\"category\":\"Payload delivery\",\"type\":\"%{[status][hits][hits][0][_source][hash_type]}\",\"value\":\"%{ioc}\",\"comment\":\"%{[status][hits][hits][0][_source][avengine]}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
        quiet => true
     }
    csv {
         fields => [ "[ioc]", "[status][hits][hits][0][_source][globaltag]", "[status][hits][hits][0][_source][avengine]", "[status][hits][hits][0][_source][analysis][threat_name]", "[status][hits][hits][0][_source][analysis][malware_family]", "[status][hits][hits][0][_source][analysis][file_info][file_type_description]", "[status][hits][hits][0][_source][hash_type]", "[tags][0]" ]
         path => "/tmp/reputation_report.csv"
     }
    }
##### IOC EXISTED IN ELASTIC FROM MISP FEEDER #####
    else if "IOC found in Elastic record" in [tags] and "IOC found in Misp record" in [status][hits][hits][0][_source][tags][0] and "hashCheck" in [route] {
    exec {
        command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Misp\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][5][name]}\"}],\"category\":\"Payload delivery\",\"type\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][type]}\",\"value\":\"%{ioc}\",\"comment\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][comment]}\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
        quiet => true
     }
    csv {
         fields => [ "[ioc]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]", "[status][hits][hits][0][_source][status][response][Attribute][0][comment]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][5][name]", "[status][hits][hits][0][_source][status][response][Attribute][0][type]", "[tags][0]" ]
         path => "/tmp/reputation_report.csv"
     }
    }
##### IOC EXISTED IN ELASTIC FROM EXTERNAL FEEDER #####
    if "IOC found in Elastic record" in [tags] and "IOC found in External record" in [status][hits][hits][0][_source][tags][0] and "domainCheck" in [route] {
     if [status][hits][hits][0][_source][analysis][lookup_results][sources][0][category] {
      exec {
         command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Returnee\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{[status][hits][hits][0][_source][verification]}\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][lookup_results][sources][0][category]}\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][lookup_results][sources][0][assessment]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{ioc}\",\"comment\":\"This ioc was verified as (%{[status][hits][hits][0][_source][verification]}) against our intel\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
         quiet => true
      }
     }
     else if ![status][hits][hits][0][_source][analysis][lookup_results][sources][0][category] {
       exec {
         command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Returnee\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{[status][hits][hits][0][_source][verification]}\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][lookup_results][sources][0][assessment]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{ioc}\",\"comment\":\"This ioc was verified as (%{[status][hits][hits][0][_source][verification]}) against our intel\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
         quiet => true
      }
     }
     csv {
          fields => [ "[ioc]", "[status][hits][hits][0][_source][globaltag]", "[status][hits][hits][0][_source][analysis][lookup_results][sources][0][category]", "[status][hits][hits][0][_source][analysis][lookup_results][sources][0][assessment]", "[tags][0]", "[status][hits][hits][0][_source][comment]" ]
          path => "/tmp/reputation_report.csv"
     }
    }
##### IOC EXISTED IN ELASTIC FROM MISP FEEDER #####
    if "IOC found in Elastic record" in [tags] and "IOC found in Misp record" in [status][hits][hits][0][_source][tags][0] and "domainCheck" in [route] {
     if [status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name] and [status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name] {
      exec {
         command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Misp\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{ioc}\",\"comment\":\"This ioc was verified as (%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}) against our intel\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
         quiet => true
      }
     }
     else if [status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name] and ![status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name] {
       exec {
         command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Misp\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}\"},{\"name\":\"[status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name]\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{ioc}\",\"comment\":\"This ioc was verified as (%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}) against our intel\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
         quiet => true
      }
     }
     else if ![status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name] and [status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name] {
       exec {
         command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Misp\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}\"},{\"name\":\"[status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name]\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{ioc}\",\"comment\":\"This ioc was verified as (%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}) against our intel\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
         quiet => true
      }
     }
      else if ![status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name] and ![status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name] {
       exec {
         command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Misp\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}\"}],\"category\":\"Network activity\",\"type\":\"domain\",\"value\":\"%{ioc}\",\"comment\":\"This ioc was verified as (%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}) against our intel\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
         quiet => true
      }
     }
     csv {
          fields => [ "[ioc]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name]", "[tags][0]", "[status][hits][hits][0][_source][status][response][Attribute][0][comment]" ]
          path => "/tmp/reputation_report.csv"
     }
    }
##### IOC EXISTED IN ELASTIC FROM EXTERNAL FEEDER #####
    if "IOC found in Elastic record" in [tags] and "IOC found in External record" in [status][hits][hits][0][_source][tags][0] and "urlCheck" in [route] {
     if [status][hits][hits][0][_source][analysis][lookup_results][sources][0][category] {
      exec {
         command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Returnee\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{[status][hits][hits][0][_source][verification]}\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][lookup_results][sources][0][category]}\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][lookup_results][sources][0][assessment]}\"}],\"category\":\"External analysis\",\"type\":\"url\",\"value\":\"%{ioc}\",\"comment\":\"This ioc was verified as (%{[status][hits][hits][0][_source][verification]}) against our intel\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
         quiet => true
      }
     }
     else if ![status][hits][hits][0][_source][analysis][lookup_results][sources][0][category] {
       exec {
         command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Returnee\"},{\"name\":\"%{globaltag}\"},{\"name\":\"%{[status][hits][hits][0][_source][verification]}\"},{\"name\":\"%{[status][hits][hits][0][_source][analysis][lookup_results][sources][0][assessment]}\"}],\"category\":\"External analysis\",\"type\":\"url\",\"value\":\"%{ioc}\",\"comment\":\"This ioc was verified as (%{[status][hits][hits][0][_source][verification]}) against our intel\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
         quiet => true
      }
     }
     csv {
          fields => [ "[ioc]", "[status][hits][hits][0][_source][globaltag]", "[status][hits][hits][0][_source][analysis][lookup_results][sources][0][category]", "[status][hits][hits][0][_source][analysis][lookup_results][sources][0][assessment]", "[tags][0]", "[status][hits][hits][0][_source][comment]" ]
          path => "/tmp/reputation_report.csv"
     }
    }
##### IOC EXISTED IN ELASTIC FROM MISP FEEDER #####
    if "IOC found in Elastic record" in [tags] and "IOC found in Misp record" in [status][hits][hits][0][_source][tags][0] and "urlCheck" in [route] {
     if [status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name] and [status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name] {
      exec {
         command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Misp\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name]}\"}],\"category\":\"External analysis\",\"type\":\"url\",\"value\":\"%{ioc}\",\"comment\":\"This ioc was verified as (%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}) against our intel\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
         quiet => true
      }
     }
     else if [status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name] and ![status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name] {
       exec {
         command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Misp\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}\"},{\"name\":\"[status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name]\"}],\"category\":\"External analysis\",\"type\":\"url\",\"value\":\"%{ioc}\",\"comment\":\"This ioc was verified as (%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}) against our intel\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
         quiet => true
      }
     }
     else if ![status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name] and [status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name] {
       exec {
         command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Misp\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}\"},{\"name\":\"[status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name]\"}],\"category\":\"External analysis\",\"type\":\"url\",\"value\":\"%{ioc}\",\"comment\":\"This ioc was verified as (%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}) against our intel\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
         quiet => true
      }
     }
      else if ![status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name] and ![status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name] {
       exec {
         command => 'curl --header "Authorization: {{MISP_API_KEY}}" --header "Accept: application/json" --header "Content-Type: application/json" -d "{\"Attribute\":[{\"Tag\":[{\"name\":\"Misp\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]}\"},{\"name\":\"%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}\"}],\"category\":\"External analysis\",\"type\":\"url\",\"value\":\"%{ioc}\",\"comment\":\"This ioc was verified as (%{[status][hits][hits][0][_source][status][response][Attribute][0][Tag][2][name]}) against our intel\"}]}" https://{{MISP_HOST}}/attributes/add/11 -k && curl -X POST -k -H "Accept:application/json" -H "Authorization:{{MISP_API_KEY}}" -H "Content-Type:application/json" "https://{{MISP_HOST}}/sightings/add" -d "{\"value\":\"%{ioc}\"}"'
         quiet => true
      }
     }
     csv {
          fields => [ "[ioc]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][1][name]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][4][name]", "[status][hits][hits][0][_source][status][response][Attribute][0][Tag][3][name]", "[tags][0]", "[status][hits][hits][0][_source][status][response][Attribute][0][comment]" ]
          path => "/tmp/reputation_report.csv"
     }
    }

#     if ![end_of_line] {
#       elasticsearch {
#           hosts => ["https://{{ELASTIC_COORDINATOR}}:9200", "https://{{ELASTIC_COORDINATOR2}}:9200"]
#           index => "misp-record%{+YYYY.MM.dd}"
#           action => "update"
#           doc_as_upsert => true
#           document_id => "%{[z-identifier]}"
#           manage_template => false
#           script => "if (ctx._source['counter'] == null) { ctx._source['counter'] = 1 } else { ctx._source.counter++ }"
#           cacert => "/etc/logstash/certs/client-ca.cer"
#           user => "elastic"
#           password => "{{ELASTIC_PASS}}"
#        }
#       }

   if "terminate" in [end_of_line] {
       email {
           to => '%{email}'
           codec => "plain"
           via => 'smtp'
           address => 'smtp.gmail.com'
           domain => 'smtp.gmail.com'
           from => '{{EMAIL}}'
           username => '{{EMAIL}}'
           password => '{{APP_PASS}}'
           subject => '{{PRODUCT}} - IOC Reputation Report'
           body => 'Do not reply! as this was generated automatically by {{PRODUCT}}'
           attachments => ["/tmp/reputation_report.csv"]
           port => 587
           use_tls => true
       }
      }
#   stdout { codec => rubydebug }
}
